<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cloud 9 Artist Finder</title>
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fuse.js for fuzzy search -->
  <script src="https://unpkg.com/fuse.js@6.6.2"></script>
  <style>
    .preline { white-space: pre-line; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <header class="max-w-5xl mx-auto p-6">
    <h1 class="text-3xl font-semibold">Cloud 9 Artist Finder</h1>
    <p class="text-sm text-slate-600 mt-1">Artist‑focused search across events & years — live from your Google Sheet.</p>
  </header>

  <main class="max-w-5xl mx-auto px-6 pb-16">
    <!-- Controls -->
    <section class="grid gap-4 md:grid-cols-12 items-end">
      <div class="md:col-span-9">
        <label class="block text-xs font-medium text-slate-600 mb-1" for="q">Search artist name</label>
        <input id="q" type="text" placeholder="Type to search… (e.g., Stoopid, Stanton Moore, Bruce Hampton)" class="w-full rounded-xl border border-slate-300 px-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div class="md:col-span-3 flex gap-2 justify-end">
        <button id="resetBtn" class="rounded-xl px-4 py-2 bg-slate-200 hover:bg-slate-300">Clear</button>
        <a id="shareBtn" class="rounded-xl px-4 py-2 bg-blue-600 text-white hover:bg-blue-700" href="#">Share search</a>
        <a id="openSheet" target="_blank" class="rounded-xl px-4 py-2 bg-slate-900 text-white hover:bg-black">Open Sheet</a>
      </div>
    </section>

    <!-- Stats -->
    <section id="stats" class="mt-4 text-sm text-slate-600 hidden"></section>

    <!-- Results -->
    <section id="results" class="mt-6 grid gap-4"></section>
  </main>

  <footer class="text-center text-xs text-slate-500 pb-8">Powered by Google Sheets · GitHub Pages ready</footer>

  <script>
    /*** CONFIG ***/
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTEDQWPOZAmYdi7gul8fgLDKsTC3uWwXNAvIUuej0aVcXyvwu6T2GJu3IAmWUrSS2zMbaVkNzScwMIi/pub?gid=1307589284&single=true&output=csv";
    const SHEET_URL = "https://docs.google.com/spreadsheets/d/2PACX-1vTEDQWPOZAmYdi7gul8fgLDKsTC3uWwXNAvIUuej0aVcXyvwu6T2GJu3IAmWUrSS2zMbaVkNzScwMIi/edit";

    const COLS = { artist: 'Artist Name', events: 'Event(s)', years: 'Year(s) Performed' };

    const $ = (id)=>document.getElementById(id);
    const resultsEl = $("results");
    const statsEl = $("stats");

    function csvToRows(text){
      const out=[], row=[]; let cur='', q=false; 
      for(let i=0;i<text.length;i++){
        const c=text[i],n=text[i+1];
        if(c==='"'){ if(q && n==='"'){cur+='"'; i++;} else {q=!q;} }
        else if(c===','&&!q){row.push(cur);cur='';}
        else if(c==='\n'&&!q){row.push(cur);out.push(row.slice());row.length=0;cur='';}
        else{cur+=c;}
      }
      if(cur.length||row.length){row.push(cur);out.push(row);} return out;
    }

    const norm = s => (s||'').toString().toLowerCase();
    const strip = s => (s||'').toString().trim();
    const extractYears = s => ((s||'').match(/\b(19\d{2}|20\d{2})\b/g)||[]).map(x=>+x);
    const hi = (text, q)=>{ if(!q) return text; try{const re=new RegExp(`(${q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'ig'); return text.replace(re,'<mark>$1</mark>');}catch{ return text; }}

    function groupByArtist(rows, idx){
      const map = new Map();
      rows.forEach(r=>{ const key = strip(r[idx.artist]); if(!key) return; if(!map.has(key)) map.set(key, []); map.get(key).push(r); });
      return map;
    }

    let ALL_ROWS=[]; let IDX={}; let FUSE=null;

    async function load(){
      if(!CSV_URL){ resultsEl.innerHTML = '<div class="text-slate-600">⚠️ No CSV_URL set.</div>'; return; }
      $("openSheet").href = SHEET_URL;

      const res = await fetch(CSV_URL); const text = await res.text();
      const rows = csvToRows(text);
      const headers = rows[0].map(h=>h.trim().toLowerCase());
      const find = name=> headers.indexOf(name.toLowerCase());
      IDX = { artist: find(COLS.artist), events: find(COLS.events), years: find(COLS.years) };
      ALL_ROWS = rows.slice(1).filter(r=> strip(r[IDX.artist]) !== '');

      FUSE = new Fuse(ALL_ROWS.map((r,i)=>({ i, artist: r[IDX.artist]||'' })), { includeScore:true, threshold:0.3, keys:['artist'] });

      const params = new URLSearchParams(location.search);
      const startQ = params.get('q')||''; $("q").value = startQ; search();
    }

    function render(groups, idx, query){
      resultsEl.innerHTML=''; let total=0;
      groups.forEach((rows, artist)=>{
        const blocks = rows.map(r=>{
          const ev = strip(r[idx.events]||'');
          const yrs = strip(r[idx.years]||'');
          return `${ev}\n${yrs}`;
        }).join('\n\n');
        total += rows.length;
        const yrsAll = Array.from(new Set(rows.flatMap(r=>extractYears(r[idx.years])))).sort((a,b)=>a-b);
        const span = yrsAll.length? `${yrsAll[0]}–${yrsAll[yrsAll.length-1]}`: '';
        const card = document.createElement('div');
        card.className = 'rounded-2xl bg-white border border-slate-200 p-4 shadow-sm hover:shadow-md transition';
        card.innerHTML = `
          <div class="flex items-start justify-between gap-4">
            <div>
              <h3 class="text-lg font-semibold">${hi(artist, strip(query))}</h3>
              ${span?`<div class="text-xs text-slate-500 mt-1">Years span: ${span}</div>`:''}
            </div>
          </div>
          <pre class="preline mt-3 text-sm">${blocks}</pre>`;
        resultsEl.appendChild(card);
      });
      statsEl.classList.toggle('hidden', groups.size===0);
      if(groups.size){ statsEl.textContent = `${groups.size} artist${groups.size!==1?'s':''} · ${total} record${total!==1?'s':''}`; }
    }

    function search(){
      const q = $("q").value.trim();
      const qn = norm(q);
      if(!q){ render(new Map(), IDX, ''); history.replaceState({},'',location.pathname); return; }

      const matches = new Set();
      ALL_ROWS.forEach((r,i)=>{ if(norm(r[IDX.artist]).includes(qn)) matches.add(i); });
      if(matches.size===0){ FUSE.search(q).slice(0,50).forEach(h=>matches.add(h.item.i)); }

      const rows = Array.from(matches).map(i=>ALL_ROWS[i]);
      const groups = groupByArtist(rows, IDX);
      render(groups, IDX, q);

      const url = new URL(location.href); url.searchParams.set('q', q); history.replaceState({},'',url);
      $("shareBtn").href = url.toString();
    }

    let t=null; $("q").addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(search,150); });
    $("resetBtn").addEventListener('click', ()=>{ $("q").value=''; search(); });

    load().catch(err=>{ resultsEl.innerHTML = `<div class="text-red-600">Error: ${err.message}</div>`; });
  </script>
</body>
</html>
